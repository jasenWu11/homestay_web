<!DOCTYPE html>
<html>
	<head>
		<title>添加房源</title>
		<link rel="stylesheet" href="lib/bootstrap/bootstrap.css">
		<link href="css/bootstrapnew.css" rel="stylesheet" type="text/css" media="all" />
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="js/jquery.min.js"></script>
		<!-- Custom Theme files -->
		<!--theme-style-->
		<link href="css/add_house.css" rel="stylesheet" type="text/css" media="all" />
		<!--//theme-style-->
		<meta name="divport" content="width=device-width, initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="keywords" content="Mattress Responsive web template, Bootstrap Web Templates, Flat Web Templates, Andriod Compatible web template, 
		Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyErricsson, Motorola web design" />
		<script charset="utf-8" src="https://map.qq.com/api/gljs?v=1.exp&key=VXYBZ-DZE6O-BCXWL-SC434-WJXQ7-WCFFK"></script>
		<link rel="stylesheet" href="lib/bootstrap-chinese-region/bootstrap-chinese-region.css">
		<script src="js/template-web.js" type="text/javascript" charset="utf-8"> </script>
		<script type="application/x-javascript">
			addEventListener("load", function() {
				setTimeout(hideURLbar, 0);
			}, false);

			function hideURLbar() {
				window.scrollTo(0, 1);
			}
		</script>
		<!--fonts-->
		<!--//fonts-->
		<!-- start menu -->
		<script src="js/template-web.js" type="text/javascript" charset="utf-8"> </script>
	</head>
	<body style="height: 100%;width: 100%;">
		<div class="base_panel">
			<button type="button" class="btn btn-danger back_html_button" onclick="back_index()">返回主页</button>
			<div class="info_main_panel">
				<div class="left_panel">
					<div class="base_info_panel">
						<div class="title_text">
							开启您的出租之旅吧
						</div>
						<div class="step_text">
							步骤1
						</div>
						<div class="tip_text">
							您打算发布怎么样的房源？
						</div>
						<div class="text_input_panel">
							<div class="input-group mb-3">
								<div class="input-group-prepend">
									<span class="input-group-text">房源名称</span>
								</div>
								<input id="housename" type="text" class="form-control" placeholder="请为您的房源取个好听的名字" aria-label="Username"
								 aria-describedby="basic-addon1">
							</div>
							<div class="input-group mb-3">
								<div class="input-group-prepend">
									<span class="input-group-text">房间规格</span>
								</div>
								<input id="specification" type="text" class="form-control" placeholder="例如房间大小或房厅卫生间情况" aria-label="Username"
								 aria-describedby="basic-addon1">
							</div>
							<div class="input-group mb-3">
								<div class="input-group-prepend">
									<span class="input-group-text">居住人数</span>
								</div>
								<select class="form-control" id="housepeople">
									<option value="1">1位</option>
									<option value="2">2位</option>
									<option value="3">3位</option>
									<option value="4">4位</option>
									<option value="5">5位</option>
									<option value="6">6位</option>
									<option value="7">7位</option>
									<option value="8">8位</option>
									<option value="9">9位</option>
									<option value="10">10位</option>
								</select>
							</div>
							<div class="input-group mb-3">
								<div class="input-group-prepend">
									<span class="input-group-text">￥</span>
								</div>
								<input id="houseprice" type="text" placeholder="请输入您的出租价格/晚" class="form-control" aria-label="Amount (to the nearest dollar)">
								<div class="input-group-append">
									<span class="input-group-text">.00</span>
								</div>
							</div>
							<div class="input-group">
								<div class="input-group-prepend">
									<span class="input-group-text">请介绍房源</span>
								</div>
								<textarea id="housedesc" class="form-control" aria-label="With textarea"></textarea>
							</div>
						</div>
						<button id="info_next" type="button" class="btn btn-primary next_button">继续</button>
					</div>
				</div>
				<div class="right_image_panel">
					<input type="image" src="https://a0.muscache.com/airbnb/static/packages/photos.6f837cb4.png" />
				</div>
			</div>
			<div class="address_main_panel">
				<div class="left_panel">
					<div class="address_info_panel">
						<div class="title_text">
							开启您的出租之旅吧
						</div>
						<div class="step_text">
							步骤2
						</div>
						<div class="tip_text">
							您的房源位于什么地方？
						</div>
						<div class="text_input_panel">
							<div class="row">
								<div class="col-md-6">
									<form action="">
										<div class="form-group">
											<div class="bs-chinese-region flat dropdown" data-min-level="1" data-max-level="3" data-def-val="[name=address]">
												<input type="text" class="form-control" placeholder="选择你的地区" data-toggle="dropdown" readonly="">
												<input type="hidden" id="address_text" class="form-control" name="address" value="441901">
												<div class="dropdown-menu" role="menu" aria-labelledby="dLabel">
													<div>
														<ul class="nav nav-tabs" role="tablist">
															<li role="presentation" class="active"><a href="#province" data-next="city" role="tab" data-toggle="tab">省份</a></li>
															<li role="presentation"><a href="#city" data-next="district" role="tab" data-toggle="tab">城市</a></li>
															<li role="presentation"><a href="#district" data-next="street" role="tab" data-toggle="tab">县区</a></li>
														</ul>
														<div class="tab-content">
															<div role="tabpanel" class="tab-pane active" id="province">--</div>
															<div role="tabpanel" class="tab-pane" id="city">--</div>
															<div role="tabpanel" class="tab-pane" id="district">--</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</form>
								</div>
							</div>
							<div class="input-group mb-3">
								<div class="input-group-prepend">
									<button class="btn btn-outline-success" type="button" id="address_back">上一步</button>
								</div>
								<input id="address" type="text" class="form-control" placeholder="请选择地图上的详细地址" aria-label="Recipient's username"
								 aria-describedby="button-addon2" readonly="readonly">
								<div class="input-group-append">
									<button class="btn btn-outline-primary" type="button" id="address_next">下一步</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="right_image_panel" style="padding: 70px 0px;margin-right: 100px;">
					<iframe id="mapPage" width="400px" height="100%" frameborder=0 src="https://apis.map.qq.com/tools/locpicker?search=1&type=1&key=VXYBZ-DZE6O-BCXWL-SC434-WJXQ7-WCFFK&referer=myapp">
					</iframe>

					<script>
						window.addEventListener('message', function(event) {
							// 接收位置信息，用户选择确认位置点后选点组件会触发该事件，回传用户的位置信息
							var loc = event.data;
							if (loc && loc.module == 'locationPicker') { //防止其他应用也会向该页面post信息，需判断module是否为'locationPicker'
								console.log('location', loc);
								address = loc.poiaddress+loc.poiname;
								$('#address').val(address)
								$('#address').removeAttr("readonly");
								latitude = loc.latlng.lat+''
								longitude = loc.latlng.lng+''
							}
						}, false);
					</script>
				</div>
			</div>
			<div class="detail_main_panel">
				<div class="left_panel">
					<div class="detail_image_view">
						<div class="title_text">
							开启您的出租之旅吧
						</div>
						<div class="step_text">
							步骤3
						</div>
						<div class="tip_text">
							为您的房源选择好看的图片吧
						</div>
						<div class="up_image_panel">
							<div class="images_view">
								<div id="showimg" class="showimg">
									<ul id="showui">
									</ul>
									<div class="upimg">
										<i class="icon-add"></i>
										<input type="file" id="upgteimg" value="" multiple />
									</div>
								</div>
							</div>
							<button class="up_button" id="submit">开始上传</button>
						</div>
					</div>
				</div>
				<div class="right_image_panel" style="padding: 70px 0px;flex-direction: column;">
					<div class="tip_text" style="margin-top: 20px;">
						您的房间有哪些便民设备？
					</div>
					<div id="device_panel" class="device_panel"></div>
					<script type="device_html/html" id="devices_tem">
						{{each device_json.device_data}}
							<div class="custom-control custom-checkbox mr-sm-2" style="margin-bottom: 15px;">
								<input name="device_check" type="checkbox" class="custom-control-input" id="{{$value.devicename}}" value="{{$value.id}}">
								<label class="custom-control-label" for="{{$value.devicename}}" style="font-size: 18px;font-weight:400;">{{$value.devicename}}</label>
							</div>
						{{/each}}
					</script>
					<div class="return_and_next_panel">
						<button id="detail_back" type="button" class="btn btn-outline-success">上一步</button>
						<button id="detail_next" type="button" class="btn btn-outline-primary">创建房源</button>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="./lib/jquery/jquery.js"></script>
	<script type="text/javascript" src="./lib/bootstrap/bootstrap.js"></script>
	<script type="text/javascript" src="./lib/bootstrap-chinese-region/bootstrap-chinese-region.js"></script>
	<script type="text/javascript">
		$.getJSON('lib/bootstrap-chinese-region/sql_areas.json', function(data) {

			for (var i = 0; i < data.length; i++) {
				var area = {
					id: data[i].id,
					name: data[i].cname,
					level: data[i].level,
					parentId: data[i].upid
				};
				data[i] = area;
			}

			$('.bs-chinese-region').chineseRegion('source', data).on('completed.bs.chinese-region', function(e, areas) {
				$(this).find('[name=address]').val(areas[areas.length - 1].id);
			});
		});
	</script>
	<script type="text/javascript">
		var hostid = getCookie('my_id');
		var ip_address = getCookie('ip_address')
		var specification = '';
		var housename = '';
		var housedesc = '';
		var houseimage = [];
		var areacode = '440143';
		var address = '';
		var longitude = '';
		var latitude = '';
		var housepeople = '';
		var houseprice = '';
		var housescore = 0;
		var deviceIds = [];
		$(document).ready(function() {
			getdevice_list()
		});

		function back_index() {
			window.parent.parent.location.href = "index.html"
		}

		function getdevice_list() {
			var ip_address = getCookie('ip_address');
			$.ajax({ //传数据的方式
				url: ip_address + "/device/list.do",
				type: "post",
				success: function(result, textStatus, request) { //传数据成功之后的操作   result是servlet传过来的数据  这个函数对result进行处理，让它显示在 输入框中
					console.log('返回了' + JSON.stringify(result))
					var status = result.status;
					if (status == 0) {
						console.log('返回正确')
						var device_data = result.data.data
						var device_json = {}
						device_json['device_data'] = device_data
						var device_html = template('devices_tem', {
							device_json: device_json
						})
						var device_panel = document.querySelector('#device_panel');
						device_panel.innerHTML = device_html;
					} else {
						var msg = result.msg;
						alert(msg)
					}
				},
				error: function(Error) {
					console.log(Error);
				},
				complete: function(xhr, data) {
					console.log("complete");
				}
			});
		}

		function getCookie(name) {
			var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
			if (arr = document.cookie.match(reg))
				return unescape(arr[2]);
			else
				return null;
		}
		$("#district").click(function() {
			var address_text = $('#address_text').val();
			areacode = address_text;
			console.log('地址是' + address_text)
		});
		$("#info_next").click(function() {
			specification = $('#specification').val()
			housename = $('#housename').val()
			housepeople = $('#housepeople option:selected').val()
			housedesc = $('#housedesc').val()
			houseprice = $('#houseprice').val()
			if(specification==""||housename==""||housepeople==""||housedesc==""||houseprice==""){
				alert("信息不能为空")
			}else{
				$('.info_main_panel').css("visibility", "hidden");
				$('.address_main_panel').css("visibility", "visible");
				$('.detail_main_panel').css("visibility", "hidden");
				console.log('房源名称' + housename + '，规格' + specification + '，价格' + houseprice + '，描述' + housedesc + '，人数' +
				housepeople)
			}
		});
		$("#address_back").click(function() {
			$('.info_main_panel').css("visibility", "visible");
			$('.address_main_panel').css("visibility", "hidden");
			$('.detail_main_panel').css("visibility", "hidden");
		});
		$("#address_next").click(function() {
			if(address==""){
				alert("请在地图选择详细地址")
			}else{
				$('.info_main_panel').css("visibility", "hidden");
				$('.address_main_panel').css("visibility", "hidden");
				$('.detail_main_panel').css("visibility", "visible");
				console.log('地区编号是' + areacode + '，地址是' + address + '，纬度' + latitude + '，经度' + longitude)	
			}
		});
		$("#detail_back").click(function() {
			$('.info_main_panel').css("visibility", "hidden");
			$('.address_main_panel').css("visibility", "visible");
			$('.detail_main_panel').css("visibility", "hidden");
		});
		$("#detail_next").click(function() {
			var ip_address = getCookie('ip_address')
			var deviceid = []
			console.log('发布房源')
			$('input[name="device_check"][type="checkbox"]:checked').each(function() {
				deviceid.push(parseInt($(this).val()))
			})
			deviceIds = deviceid
			console.log('设备ids为' + JSON.stringify(deviceIds))
			var houseimage_data = JSON.stringify(houseimage)
			var up_data = {}
			up_data['housename'] = housename;
			up_data['hostid'] = hostid;
			up_data['specification'] = specification;
			up_data['areacode'] = areacode;
			up_data['longitude'] = longitude;
			up_data['latitude'] = latitude;
			up_data['address'] = address;
			up_data['houseprice'] = houseprice;
			up_data['housepeople'] = housepeople;
			up_data['deviceIds'] = deviceIds;
			up_data['houseimage'] = houseimage_data;
			$.ajax({
				type: "POST",
				url: ip_address + "/house/create.do?",
				data: JSON.stringify(up_data),
				contentType: "application/json;charset=utf-8", //必须要设置
				dataType: "json", //返回的数据格式为json
				success: function(result) {
					console.log(JSON.stringify(result));
					var status = result.status;
					if (status == 0) {
						alert("创建房源成功");
						var data = result.data;
						window.location.href = "house_deatil.html?house_id=" + data;
					} else {
						var msg = result.msg;
						alert(msg);
					}
				},
				error: function(xhr, state, errorThrown) {
					alert("服务请求错误")
				}
			});
		});
		window.onload = function() {
			var input = document.getElementById("upgteimg");
			var showui = document.getElementById("showui");
			var result;
			var dataArr = []; // 储存所选图片的结果(文件名和base64数据)  
			var fd; //FormData方式发送请求    
			var oSelect = document.getElementById("select");
			var oAdd = document.getElementById("add");
			var showinput = document.getElementById("showinput");
			var oSubmit = document.getElementById("submit");
			var oInput = document.getElementById("upgteimg");
			var lilength = showui.getElementsByTagName('li');

			function show() {}
			//监听展示图片的ul,执行判断是否隐藏
			showui.addEventListener("click", function() {
				show();
			});
			if (typeof FileReader === 'undefined') {
				alert("抱歉，你的浏览器不支持 FileReader");
				input.setAttribute('disabled', 'disabled');
			} else {
				input.addEventListener('change', readFile, false);
			}

			function readFile() {
				fd = new FormData();
				var iLen = this.files.length;
				var index = 0;
				var currentReViewImgIndex = 0;
				for (var i = 0; i < iLen; i++) {
					if (!input['value'].match(/.jpg|.gif|.png|.jpeg|.bmp/i)) { //判断上传文件格式    
						return alert("上传的图片格式不正确，请重新选择");
					}
					var reader = new FileReader();
					reader.index = i;
					fd.append(i, this.files[i]);
					var file = this.files[i]
					reader.readAsDataURL(this.files[i]); //转成base64    
					reader.fileName = this.files[i].name;
					reader.onload = function(e) {
						var imgMsg = {
							name: this.fileName, //获取文件名    
							base64: this.result, //reader.readAsDataURL方法执行完后，base64数据储存在reader.result里    
							file: file
						}
						dataArr.push(imgMsg);
						for (var j = 0; j < dataArr.length; j++) {
							currentReViewImgIndex = j
						}
						result =
							'<div class="showdiv"><img class="left" src="images/Arrow_left.svg" /><img class="center" src="images/delete.svg" /><img class="right" src="images/Arrow_right.svg" /></div><img id="srcimgid' +
							currentReViewImgIndex + '" class="showimg" src="' + this.result + '" />';

						var li = document.createElement('li');
						li.innerHTML = result;
						showui.appendChild(li);
						var left = li.getElementsByTagName('img')[0];
						var center = li.getElementsByTagName('img')[1];
						var right = li.getElementsByTagName('img')[2];
						var src = li.getElementsByTagName('img')[3];
						show()

						left.onclick = function(num) {
							return function() {
								if (num == 0) {

								} else {
									var list = 0;
									for (var j = 0; j < dataArr.length; j++) {
										list = j
									}
									dataArr.splice(up, 0, dataArr[num]);
									dataArr.splice(num + 1, 1)
									var up = num - 1;
									for (var j = 0; j < list + 1; j++) {
										$("#srcimgid" + j + "").attr("src", dataArr[j].base64)
									}
									console.log(dataArr)
								}
							}
						}(currentReViewImgIndex)

						center.onclick = function(num) {
							return function() {
								li.remove(); // 在页面中删除该图片元素  
								dataArr.splice(num, 1)
							}
						}(currentReViewImgIndex)

						right.onclick = function(num) {
							return function() {

								var list = 0;
								for (var j = 0; j < dataArr.length; j++) {
									list = j
								}

								dataArr.splice(list + 1, 0, dataArr[num]);
								dataArr.splice(num, 1)
								var down = num - 1;
								var datalist = list + 1;
								for (var j = 0; j < datalist; j++) {
									$("#srcimgid" + j + "").attr("src", dataArr[j].base64)
								}

							}
						}(currentReViewImgIndex)
						index++;

					}
				}
			}

			function send() {
				houseimage = []
				var ip_address = getCookie('ip_address')
				var dataArr_list = []
				for (var j = 0; j < dataArr.length; j++) {
					// var arr_64 = dataArr[j].base64
					// dataArr_list.push(arr_64)
					console.log('dataArr[j].name' + dataArr[j].file)
					var formData = new FormData();
					formData.append('image', dataArr[j].file);
					$.ajax({
						url: ip_address + '/common/upload.do',
						data: formData,
						type: 'post',
						processData: false, // 告诉jQuery不要去处理发送的数据
						contentType: false, // 告诉jQuery不要去设置Content-Type请求头
						success: function(result) {
							console.log(JSON.stringify(result));
							var status = result.status;
							if (status == 0) {
								var data = result.data;
								var url = data.url;
								var urls = {}
								urls['url'] = url
								houseimage.push(urls);
								if (houseimage.length == dataArr.length) {
									alert('上传成功')
								}
								console.log('图片链接' + JSON.stringify(houseimage))
							} else {
								alert('上传失败')
							}
						}
					});
				}
			}

			oSubmit.onclick = function() {
				if (!dataArr.length) {
					return alert('请先选择文件');
				}
				send();
			}

			$('#showui').on('DOMNodeInserted', function() {
				show();
			})
		}
	</script>
</html>
